name: 构建树莓派4 Android系统集成KernelSU

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置环境
      run: |
        sudo apt update
        sudo apt install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev \
        libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
        
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH=~/bin:$PATH
        
    - name: 初始化Repo
      run: |
        mkdir -p ~/android-rpi
        cd ~/android-rpi
        repo init -u https://android.googlesource.com/platform/manifest -b android-13.0.0_r8
        git clone https://github.com/raspberry-vanilla/android_local_manifest .repo/local_manifests
        
    - name: 同步源代码
      run: |
        cd ~/android-rpi
        repo sync -j$(nproc)
        
    - name: 集成KernelSU
      run: |
        cd ~/android-rpi/kernel/brcm/rpi
        git submodule add https://github.com/tiann/KernelSU KernelSU
        
        # 修改Makefile添加KernelSU支持
        echo '# KernelSU' >> Makefile
        echo 'export KERNELSU_TAG=main' >> Makefile
        echo 'export KERNELSU_PATH=$(srctree)/KernelSU' >> Makefile
        echo '-include $(KERNELSU_PATH)/kernel/setup.mk' >> Makefile
        
        # 修改内核配置
        echo 'CONFIG_KPROBES=y' >> arch/arm64/configs/bcm2711_defconfig
        echo 'CONFIG_HAVE_KPROBES=y' >> arch/arm64/configs/bcm2711_defconfig
        echo 'CONFIG_KPROBE_EVENTS=y' >> arch/arm64/configs/bcm2711_defconfig
        
    - name: 编译系统
      run: |
        cd ~/android-rpi
        source build/envsetup.sh
        lunch rpi4-userdebug
        make bootimage -j$(nproc)
        make -j$(nproc)
        
    - name: 上传构建结果
      uses: actions/upload-artifact@v4
      with:
        name: rpi4-android-kernelsu
        path: ~/android-rpi/out/target/product/rpi4/
