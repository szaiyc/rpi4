name: Build Raspberry Pi 4 KernelSU

on:
  workflow_dispatch:
    inputs:
      ANDROID_BRANCH:
        description: 'Androidåˆ†æ”¯'
        required: true
        default: 'master'  # ä¿®æ”¹ä¸ºé»˜è®¤åˆ†æ”¯
        type: choice
        options:
          - 'master'
          - 'lineage-19.1'
          - 'lineage-18.1'
      KERNELSU_VERSION:
        description: 'KernelSUç‰ˆæœ¬'
        required: true
        default: 'v0.9.5'
        type: choice
        options:
          - 'v0.9.5'
          - 'v0.6.7'
          - 'v0.5.2'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEVICE_PATH: android_device_brcm_rpi4
      KERNEL_PATH: android_kernel_brcm_rpi
      ARCH: arm64

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            binutils-aarch64-linux-gnu \
            binutils-arm-linux-gnueabi \
            make \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            ccache \
            kmod \
            cpio \
            build-essential \
            zip \
            curl \
            zlib1g-dev \
            libncurses5-dev \
            git \
            python3 \
            python3-pip \
            device-tree-compiler \
            abootimg

      - name: Set Date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Check Repository Branches
        run: |
          echo "ğŸ” æ£€æŸ¥è®¾å¤‡ä»“åº“å¯ç”¨åˆ†æ”¯..."
          git ls-remote --heads https://github.com/raspberry-vanilla/android_device_brcm_rpi4 | grep -oE 'refs/heads/[^/]+' | sed 's#refs/heads/##'
          
          echo "ğŸ” æ£€æŸ¥å†…æ ¸ä»“åº“å¯ç”¨åˆ†æ”¯..."
          git ls-remote --heads https://github.com/raspberry-vanilla/android_kernel_brcm_rpi | grep -oE 'refs/heads/[^/]+' | sed 's#refs/heads/##'

      - name: Clone Device Repository
        run: |
          echo "ğŸ“¥ å…‹éš†è®¾å¤‡ä»“åº“..."
          # å…ˆå°è¯•æŒ‡å®šåˆ†æ”¯ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•masteråˆ†æ”¯
          if git clone --depth=1 -b ${{ github.event.inputs.ANDROID_BRANCH }} https://github.com/raspberry-vanilla/android_device_brcm_rpi4 ${DEVICE_PATH}; then
            echo "âœ… è®¾å¤‡ä»“åº“å…‹éš†æˆåŠŸï¼Œä½¿ç”¨åˆ†æ”¯: ${{ github.event.inputs.ANDROID_BRANCH }}"
          else
            echo "âš ï¸ æŒ‡å®šåˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨masteråˆ†æ”¯..."
            git clone --depth=1 https://github.com/raspberry-vanilla/android_device_brcm_rpi4 ${DEVICE_PATH}
            cd ${DEVICE_PATH}
            echo "âœ… è®¾å¤‡ä»“åº“å…‹éš†æˆåŠŸï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯: $(git branch --show-current)"
            cd ..
          fi

      - name: Determine Kernel Branch
        run: |
          echo "ğŸ“¥ ç¡®å®šå†…æ ¸åˆ†æ”¯..."
          # ä»è®¾å¤‡ä»“åº“æå–å†…æ ¸åˆ†æ”¯
          if grep -q "BOARD_KERNEL_SOURCE.*android-" ${DEVICE_PATH}/BoardConfig.mk; then
            KERNEL_BRANCH=$(grep "BOARD_KERNEL_SOURCE.*android-" ${DEVICE_PATH}/BoardConfig.mk | sed -E 's/.*android-([0-9\.]+).*/android-\1/')
            echo "ä»BoardConfig.mkæå–çš„å†…æ ¸åˆ†æ”¯: ${KERNEL_BRANCH}"
          else
            # é»˜è®¤ä½¿ç”¨android-13.0åˆ†æ”¯
            KERNEL_BRANCH="android-13.0"
            echo "ä½¿ç”¨é»˜è®¤å†…æ ¸åˆ†æ”¯: ${KERNEL_BRANCH}"
          fi
          
          # éªŒè¯å†…æ ¸åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads https://github.com/raspberry-vanilla/android_kernel_brcm_rpi ${KERNEL_BRANCH}; then
            echo "ç¡®è®¤å†…æ ¸åˆ†æ”¯å­˜åœ¨: ${KERNEL_BRANCH}"
          else
            echo "âš ï¸ å†…æ ¸åˆ†æ”¯ ${KERNEL_BRANCH} ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨android-13.0..."
            if git ls-remote --exit-code --heads https://github.com/raspberry-vanilla/android_kernel_brcm_rpi android-13.0; then
              KERNEL_BRANCH="android-13.0"
              echo "ä½¿ç”¨å†…æ ¸åˆ†æ”¯: android-13.0"
            else
              echo "âš ï¸ android-13.0åˆ†æ”¯ä¹Ÿä¸å­˜åœ¨ï¼Œå°è¯•è·å–é»˜è®¤åˆ†æ”¯..."
              KERNEL_BRANCH="master"
              echo "ä½¿ç”¨å†…æ ¸é»˜è®¤åˆ†æ”¯: master"
            fi
          fi
          
          # å­˜å‚¨å†…æ ¸åˆ†æ”¯ä¸ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "KERNEL_BRANCH=${KERNEL_BRANCH}" >> $GITHUB_ENV

      - name: Clone Kernel Repository
        run: |
          echo "ğŸ“¥ å…‹éš†å†…æ ¸ä»“åº“..."
          git clone --depth=1 -b ${KERNEL_BRANCH} https://github.com/raspberry-vanilla/android_kernel_brcm_rpi ${KERNEL_PATH}
          echo "âœ… å†…æ ¸ä»“åº“å…‹éš†å®Œæˆ"
          
          # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          cd ${KERNEL_PATH}
          KERNEL_VERSION=$(make kernelversion)
          echo "å†…æ ¸ç‰ˆæœ¬: ${KERNEL_VERSION}"

      - name: Setup KernelSU
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "ğŸ“¥ é›†æˆKernelSU ${{ github.event.inputs.KERNELSU_VERSION }}..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ github.event.inputs.KERNELSU_VERSION }}
          echo "âœ… KernelSUé›†æˆå®Œæˆ"
          ls -la KernelSU/

      - name: Configure Kernel
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "âš™ï¸ é…ç½®å†…æ ¸..."
          mkdir -p out
          
          # è·å–å†…æ ¸é…ç½®æ–‡ä»¶
          if [ -f "../${DEVICE_PATH}/BoardConfig.mk" ]; then
            KERNEL_CONFIG=$(grep "TARGET_KERNEL_CONFIG" ../${DEVICE_PATH}/BoardConfig.mk | sed 's/.*:= //')
            if [ -z "$KERNEL_CONFIG" ]; then
              echo "æ— æ³•ä»BoardConfig.mkæ‰¾åˆ°å†…æ ¸é…ç½®ï¼ŒæŸ¥æ‰¾å¯ç”¨çš„defconfig..."
              find arch/arm64/configs/ -name "*_defconfig" | sort
              # å°è¯•ä½¿ç”¨lineageos_rpi4_defconfigæˆ–å…¶ä»–å¤‡é€‰é…ç½®
              if [ -f "arch/arm64/configs/lineageos_rpi4_defconfig" ]; then
                KERNEL_CONFIG="lineageos_rpi4_defconfig"
              elif [ -f "arch/arm64/configs/bcm2711_defconfig" ]; then
                KERNEL_CONFIG="bcm2711_defconfig"
              else
                # ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªdefconfig
                KERNEL_CONFIG=$(find arch/arm64/configs/ -name "*_defconfig" | head -1 | xargs basename)
              fi
            fi
          else
            echo "BoardConfig.mkä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾å¯ç”¨çš„defconfig..."
            find arch/arm64/configs/ -name "*_defconfig" | sort
            # ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªdefconfig
            KERNEL_CONFIG=$(find arch/arm64/configs/ -name "*_defconfig" | head -1 | xargs basename)
          fi
          echo "ä½¿ç”¨å†…æ ¸é…ç½®: ${KERNEL_CONFIG}"
          
          # åº”ç”¨å†…æ ¸é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- ${KERNEL_CONFIG}
          
          # å¯ç”¨KernelSUæ‰€éœ€é…ç½®
          echo "âš™ï¸ å¯ç”¨KernelSUæ‰€éœ€é…ç½®..."
          scripts/config --file out/.config \
            -e CONFIG_KPROBES \
            -e CONFIG_HAVE_KPROBES \
            -e CONFIG_KPROBE_EVENTS \
            -e CONFIG_KSU
          
          # å¯ç”¨DTBæ”¯æŒï¼ˆæ ‘è“æ´¾éœ€è¦ï¼‰
          echo "âš™ï¸ å¯ç”¨è®¾å¤‡æ ‘æ”¯æŒ..."
          scripts/config --file out/.config \
            -e CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE \
            -e CONFIG_BUILD_ARM64_DTB_OVERLAY_IMAGE
          
          # ç¦ç”¨å¯èƒ½å¯¼è‡´é—®é¢˜çš„åŠŸèƒ½
          echo "âš™ï¸ ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½..."
          scripts/config --file out/.config \
            -d CONFIG_EXTRA_FIRMWARE \
            -d CONFIG_EXTRA_FIRMWARE_DIR \
            -d CONFIG_DEBUG_INFO \
            -d CONFIG_LTO \
            -d CONFIG_CC_WERROR
          
          # æ›´æ–°é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
          echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
          
          # ç®€å•æµ‹è¯•æ˜¯å¦èƒ½ç¼–è¯‘
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- -j1 scripts

      # åç»­æ­¥éª¤ä¿æŒä¸å˜...
