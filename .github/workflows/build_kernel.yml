name: Build RPi4 Android Kernel with KernelSU

on:
  workflow_dispatch:
    inputs:
      KERNEL_BRANCH:
        description: 'å†…æ ¸åˆ†æ”¯'
        required: true
        default: 'android-13.0'
      KERNELSU_VERSION:
        description: 'KernelSUç‰ˆæœ¬'
        required: true
        default: 'v0.7.6'
      DEVICE_BRANCH:
        description: 'è®¾å¤‡æ ‘åˆ†æ”¯'
        required: true
        default: 'lineage-20.0'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      KERNEL_SOURCE: https://github.com/raspberry-vanilla/android_kernel_brcm_rpi
      DEVICE_SOURCE: https://github.com/raspberry-vanilla/android_device_brcm_rpi4
      KERNEL_CONFIG: lineageos_rpi4_defconfig
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_ARM32: arm-linux-gnueabi-
      CLANG_TRIPLE: aarch64-linux-gnu-

    steps:
      - name: Setup Build Environment
        run: |
          echo "ðŸ”§ å®‰è£…åŸºç¡€ä¾èµ–åŒ…..."
          sudo apt-get update
          sudo apt-get install -y \
            git ccache automake flex lzop bison \
            gperf build-essential zip curl zlib1g-dev \
            bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev \
            squashfs-tools pngcrush schedtool dpkg-dev \
            liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils \
            minicom libxml-sax-base-perl libxml-simple-perl \
            bc libc6-dev-i386 lib32ncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev \
            libgl1-mesa-dev xsltproc unzip device-tree-compiler

          echo "ðŸ”§ å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾..."
          # ç§»é™¤å¯èƒ½å†²çªçš„åŒ…
          sudo apt-get remove -y gcc-multilib || true
          
          # æ·»åŠ ARMæž¶æž„æ”¯æŒ
          sudo dpkg --add-architecture arm64
          sudo dpkg --add-architecture armhf
          
          # æ›´æ–°è½¯ä»¶æº
          sudo apt-get update
          
          # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            g++-arm-linux-gnueabi \
            binutils-aarch64-linux-gnu \
            binutils-arm-linux-gnueabi

          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          
          # éªŒè¯å·¥å…·é“¾å®‰è£…
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabi-gcc --version

      - name: Clone Kernel Source
        run: |
          echo "ðŸ“¥ å…‹éš†å†…æ ¸æºç ..."
          git clone --depth=1 -b ${{ github.event.inputs.KERNEL_BRANCH }} ${KERNEL_SOURCE} kernel_source
          cd kernel_source
          echo "âœ… å†…æ ¸æºç ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          git log -1 --oneline

      - name: Clone Device Tree
        run: |
          echo "ðŸ“¥ å…‹éš†è®¾å¤‡æ ‘..."
          git clone --depth=1 -b ${{ github.event.inputs.DEVICE_BRANCH }} ${DEVICE_SOURCE} device_tree
          echo "âœ… è®¾å¤‡æ ‘å…‹éš†å®Œæˆ"

      - name: Setup KernelSU
        working-directory: kernel_source
        run: |
          echo "ðŸ“¥ é›†æˆKernelSU ${{ github.event.inputs.KERNELSU_VERSION }}..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ github.event.inputs.KERNELSU_VERSION }}
          echo "âœ… KernelSUé›†æˆå®Œæˆ"

      - name: Configure Kernel
        working-directory: kernel_source
        run: |
          echo "âš™ï¸ é…ç½®å†…æ ¸..."
          mkdir -p out
          
          # åº”ç”¨åŸºç¡€é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE} ${KERNEL_CONFIG}
          
          # å¯ç”¨KernelSUå¿…éœ€çš„é…ç½®
          scripts/config --file out/.config \
            -e CONFIG_KPROBES \
            -e CONFIG_HAVE_KPROBES \
            -e CONFIG_KPROBE_EVENTS \
            -e CONFIG_MODULES \
            -e CONFIG_IKCONFIG \
            -e CONFIG_IKCONFIG_PROC \
            -e CONFIG_FUNCTION_TRACER \
            -e CONFIG_FUNCTION_GRAPH_TRACER \
            -e CONFIG_KPROBES_ON_FTRACE \
            -e CONFIG_OVERLAY_FS \
            -e CONFIG_KSU
          
          # æ›´æ–°é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE} olddefconfig
          
          echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"

      - name: Build Kernel
        working-directory: kernel_source
        run: |
          echo "ðŸ”¨ ç¼–è¯‘å†…æ ¸..."
          make O=out ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE} -j$(nproc --all) 2>&1 | tee build.log
          
          if [ -f "out/arch/${ARCH}/boot/Image.gz" ]; then
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: Package Kernel
        run: |
          echo "ðŸ“¦ æ‰“åŒ…å†…æ ¸æ–‡ä»¶..."
          mkdir -p release
          
          # å¤åˆ¶å†…æ ¸æ–‡ä»¶
          cp kernel_source/out/arch/${ARCH}/boot/Image.gz release/
          cp kernel_source/out/arch/${ARCH}/boot/dts/broadcom/*.dtb release/
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > release/version.txt << EOF
          Kernel Version: ${{ github.event.inputs.KERNEL_BRANCH }}
          KernelSU Version: ${{ github.event.inputs.KERNELSU_VERSION }}
          Build Date: $(date '+%Y-%m-%d %H:%M:%S')
          EOF
          
          # æ‰“åŒ…
          cd release
          zip -r ../kernel-su-rpi4.zip *
          cd ..

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-su-rpi4
          path: |
            kernel-su-rpi4.zip
            kernel_source/build.log
          retention-days: 7

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: kernel-su-rpi4.zip
          name: KernelSU for RPi4 - ${{ github.event.inputs.KERNELSU_VERSION }}
          tag_name: kernelsu-${{ github.run_number }}
          body: |
            æ ‘èŽ“æ´¾4 KernelSU å†…æ ¸
            
            - å†…æ ¸åˆ†æ”¯: ${{ github.event.inputs.KERNEL_BRANCH }}
            - KernelSUç‰ˆæœ¬: ${{ github.event.inputs.KERNELSU_VERSION }}
            - è®¾å¤‡æ ‘åˆ†æ”¯: ${{ github.event.inputs.DEVICE_BRANCH }}
            
            ### å®‰è£…è¯´æ˜Ž
            1. è§£åŽ‹zipåŒ…
            2. æ›¿æ¢bootåˆ†åŒºä¸­çš„kernel8.img
            3. å®‰è£…KernelSU Manageråº”ç”¨
            4. é‡å¯è®¾å¤‡
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
