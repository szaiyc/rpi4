name: Build Raspberry Pi 4 KernelSU

on:
  workflow_dispatch:
    inputs:
      ANDROID_BRANCH:
        description: 'Androidåˆ†æ”¯'
        required: true
        default: 'lineage-20.0'
        type: choice
        options:
          - 'lineage-20.0'
          - 'lineage-19.1'
          - 'lineage-18.1'
      KERNELSU_VERSION:
        description: 'KernelSUç‰ˆæœ¬'
        required: true
        default: 'v0.9.5'
        type: choice
        options:
          - 'v0.9.5'
          - 'v0.6.7'
          - 'v0.5.2'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEVICE_PATH: android_device_brcm_rpi4
      KERNEL_PATH: android_kernel_brcm_rpi
      ARCH: arm64

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            binutils-aarch64-linux-gnu \
            binutils-arm-linux-gnueabi \
            make \
            bc \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            ccache \
            kmod \
            cpio \
            build-essential \
            zip \
            curl \
            zlib1g-dev \
            libncurses5-dev \
            git \
            python3 \
            python3-pip \
            device-tree-compiler \
            abootimg

      - name: Set Date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Clone Device Repositories
        run: |
          echo "ğŸ“¥ å…‹éš†è®¾å¤‡ä»“åº“..."
          git clone --depth=1 -b ${{ github.event.inputs.ANDROID_BRANCH }} https://github.com/raspberry-vanilla/android_device_brcm_rpi4 ${DEVICE_PATH}
          echo "âœ… è®¾å¤‡ä»“åº“å…‹éš†å®Œæˆ"
          
          echo "ğŸ“¥ ç¡®å®šå†…æ ¸åˆ†æ”¯..."
          # ä»è®¾å¤‡ä»“åº“æå–å†…æ ¸åˆ†æ”¯
          if grep -q "BOARD_KERNEL_SOURCE.*android-" ${DEVICE_PATH}/BoardConfig.mk; then
            KERNEL_BRANCH=$(grep "BOARD_KERNEL_SOURCE.*android-" ${DEVICE_PATH}/BoardConfig.mk | sed -E 's/.*android-([0-9\.]+).*/android-\1/')
          else
            # é»˜è®¤ä½¿ç”¨android-13.0åˆ†æ”¯
            KERNEL_BRANCH="android-13.0"
          fi
          echo "ä½¿ç”¨å†…æ ¸åˆ†æ”¯: ${KERNEL_BRANCH}"
          
          echo "ğŸ“¥ å…‹éš†å†…æ ¸ä»“åº“..."
          git clone --depth=1 -b ${KERNEL_BRANCH} https://github.com/raspberry-vanilla/android_kernel_brcm_rpi ${KERNEL_PATH}
          echo "âœ… å†…æ ¸ä»“åº“å…‹éš†å®Œæˆ"
          
          # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          cd ${KERNEL_PATH}
          KERNEL_VERSION=$(make kernelversion)
          echo "å†…æ ¸ç‰ˆæœ¬: ${KERNEL_VERSION}"

      - name: Setup KernelSU
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "ğŸ“¥ é›†æˆKernelSU ${{ github.event.inputs.KERNELSU_VERSION }}..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ github.event.inputs.KERNELSU_VERSION }}
          echo "âœ… KernelSUé›†æˆå®Œæˆ"
          ls -la KernelSU/

      - name: Configure Kernel
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "âš™ï¸ é…ç½®å†…æ ¸..."
          mkdir -p out
          
          # è·å–å†…æ ¸é…ç½®æ–‡ä»¶
          if [ -f "../${DEVICE_PATH}/BoardConfig.mk" ]; then
            KERNEL_CONFIG=$(grep "TARGET_KERNEL_CONFIG" ../${DEVICE_PATH}/BoardConfig.mk | sed 's/.*:= //')
            if [ -z "$KERNEL_CONFIG" ]; then
              KERNEL_CONFIG="lineageos_rpi4_defconfig"
            fi
          else
            KERNEL_CONFIG="lineageos_rpi4_defconfig"
          fi
          echo "ä½¿ç”¨å†…æ ¸é…ç½®: ${KERNEL_CONFIG}"
          
          # åº”ç”¨å†…æ ¸é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- ${KERNEL_CONFIG}
          
          # å¯ç”¨KernelSUæ‰€éœ€é…ç½®
          echo "âš™ï¸ å¯ç”¨KernelSUæ‰€éœ€é…ç½®..."
          scripts/config --file out/.config \
            -e CONFIG_KPROBES \
            -e CONFIG_HAVE_KPROBES \
            -e CONFIG_KPROBE_EVENTS \
            -e CONFIG_KSU
          
          # å¯ç”¨DTBæ”¯æŒï¼ˆæ ‘è“æ´¾éœ€è¦ï¼‰
          echo "âš™ï¸ å¯ç”¨è®¾å¤‡æ ‘æ”¯æŒ..."
          scripts/config --file out/.config \
            -e CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE \
            -e CONFIG_BUILD_ARM64_DTB_OVERLAY_IMAGE
          
          # ç¦ç”¨å¯èƒ½å¯¼è‡´é—®é¢˜çš„åŠŸèƒ½
          echo "âš™ï¸ ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½..."
          scripts/config --file out/.config \
            -d CONFIG_EXTRA_FIRMWARE \
            -d CONFIG_EXTRA_FIRMWARE_DIR \
            -d CONFIG_DEBUG_INFO \
            -d CONFIG_LTO \
            -d CONFIG_CC_WERROR
          
          # æ›´æ–°é…ç½®
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
          echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
          
          # ç®€å•æµ‹è¯•æ˜¯å¦èƒ½ç¼–è¯‘
          make O=out ARCH=${ARCH} CROSS_COMPILE=aarch64-linux-gnu- -j1 scripts

      - name: Build Kernel
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å†…æ ¸..."
          # ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¹¶è®°å½•æ—¥å¿—
          make O=out \
            ARCH=${ARCH} \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            -j$(nproc) \
            V=1 2>&1 | tee build.log
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†Image.gz
          if [ -f "out/arch/${ARCH}/boot/Image.gz" ]; then
            echo "âœ… å†…æ ¸Image.gzåˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ å†…æ ¸Image.gzåˆ›å»ºå¤±è´¥"
            tail -n 100 build.log
            exit 1
          fi

      - name: Build DTBs and Create Image.gz-dtb
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "ğŸ”¨ ç¼–è¯‘è®¾å¤‡æ ‘æ–‡ä»¶..."
          # ç¼–è¯‘æ‰€æœ‰DTBæ–‡ä»¶
          make O=out \
            ARCH=${ARCH} \
            CROSS_COMPILE=aarch64-linux-gnu- \
            dtbs -j$(nproc)
          
          echo "ğŸ” æŸ¥æ‰¾æ ‘è“æ´¾4 DTBæ–‡ä»¶..."
          # æŸ¥æ‰¾å¹¶æ˜¾ç¤ºBCM2711 DTBæ–‡ä»¶
          find out/arch/${ARCH}/boot/dts/ -name "bcm2711-*.dtb" | sort
          
          # æ‰¾åˆ°BCM2711 DTBå¹¶åˆå¹¶åˆ°Image.gz
          RPI4_DTB=$(find out/arch/${ARCH}/boot/dts/ -name "bcm2711-*.dtb" | head -1)
          if [ -n "$RPI4_DTB" ]; then
            echo "âœ… æ‰¾åˆ°DTBæ–‡ä»¶: $RPI4_DTB"
            echo "ğŸ”¨ åˆå¹¶å†…æ ¸ä¸DTB..."
            cat out/arch/${ARCH}/boot/Image.gz "$RPI4_DTB" > out/arch/${ARCH}/boot/Image.gz-dtb
            echo "âœ… åˆ›å»ºImage.gz-dtbæˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°BCM2711 DTBï¼Œå°è¯•ä½¿ç”¨å…¶å®ƒDTB..."
            find out/arch/${ARCH}/boot/dts/ -name "*.dtb" > dtb_files.txt
            if [ -s dtb_files.txt ]; then
              DTB_FILE=$(cat dtb_files.txt | head -1)
              echo "âœ… ä½¿ç”¨DTB: $DTB_FILE"
              cat out/arch/${ARCH}/boot/Image.gz "$DTB_FILE" > out/arch/${ARCH}/boot/Image.gz-dtb
              echo "âœ… åˆ›å»ºImage.gz-dtbæˆåŠŸ"
            else
              echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°DTBæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨Image.gz..."
              cp out/arch/${ARCH}/boot/Image.gz out/arch/${ARCH}/boot/Image.gz-dtb
            fi
          fi
          
          # æ£€æŸ¥ç”Ÿæˆçš„Image.gz-dtb
          ls -lh out/arch/${ARCH}/boot/Image.gz-dtb

      - name: Prepare Release Files
        working-directory: ${{ env.KERNEL_PATH }}
        run: |
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ../release/{boot,system}
          
          # å¤åˆ¶å†…æ ¸æ–‡ä»¶ (ä¸¤ç§æ ¼å¼)
          cp out/arch/${ARCH}/boot/Image.gz-dtb ../release/boot/Image.gz-dtb
          cp out/arch/${ARCH}/boot/Image.gz-dtb ../release/boot/kernel8.img
          
          # å¤åˆ¶DTBæ–‡ä»¶
          mkdir -p ../release/boot/dtbs
          cp -r out/arch/${ARCH}/boot/dts/broadcom/ ../release/boot/dtbs/
          
          # ç¼–è¯‘è®¾å¤‡æ ‘è¦†ç›–æ–‡ä»¶
          if [ -d "arch/${ARCH}/boot/dts/overlays" ]; then
            echo "ğŸ”¨ ç¼–è¯‘è®¾å¤‡æ ‘è¦†ç›–æ–‡ä»¶..."
            mkdir -p ../release/boot/overlays
            
            # æŸ¥æ‰¾æ‰€æœ‰DTSæ–‡ä»¶
            find arch/${ARCH}/boot/dts/overlays -name "*.dts" -type f | while read dts_file; do
              base_name=$(basename "$dts_file" .dts)
              echo "ç¼–è¯‘: $dts_file -> $base_name.dtbo"
              
              # ä½¿ç”¨DTCç¼–è¯‘DTSä¸ºDTBO
              dtc -@ -I dts -O dtb -o "../release/boot/overlays/$base_name.dtbo" "$dts_file"
            done
            
            # å¤åˆ¶READMEæ–‡ä»¶å¦‚æœå­˜åœ¨
            if [ -f "arch/${ARCH}/boot/dts/overlays/README" ]; then
              cp arch/${ARCH}/boot/dts/overlays/README ../release/boot/overlays/
            fi
            
            echo "âœ… è®¾å¤‡æ ‘è¦†ç›–æ–‡ä»¶ç¼–è¯‘å®Œæˆ"
          fi
          
          # å‡†å¤‡KernelSUç®¡ç†å™¨APK
          echo "ğŸ“± ä¸‹è½½KernelSUç®¡ç†å™¨åº”ç”¨..."
          curl -L -o ../release/system/KernelSU.apk https://github.com/tiann/KernelSU/releases/download/${{ github.event.inputs.KERNELSU_VERSION }}/KernelSU_${{ github.event.inputs.KERNELSU_VERSION }}.apk
          echo "âœ… KernelSUç®¡ç†å™¨ä¸‹è½½å®Œæˆ"
          
          # åˆ›å»ºå®‰è£…æŒ‡å—
          echo "# æ ‘è“æ´¾4 KernelSU å®‰è£…æŒ‡å—" > ../release/README.md
          echo "" >> ../release/README.md
          echo "## ç‰ˆæœ¬ä¿¡æ¯" >> ../release/README.md
          echo "- Androidåˆ†æ”¯: ${{ github.event.inputs.ANDROID_BRANCH }}" >> ../release/README.md
          echo "- KernelSUç‰ˆæœ¬: ${{ github.event.inputs.KERNELSU_VERSION }}" >> ../release/README.md
          echo "- æ„å»ºæ—¥æœŸ: ${{ steps.date.outputs.date }}" >> ../release/README.md
          echo "" >> ../release/README.md
          echo "## é€‚ç”¨äºAndroidç³»ç»Ÿ" >> ../release/README.md
          echo "1. å¤‡ä»½åŸå§‹boot.img" >> ../release/README.md
          echo "2. è§£åŒ…boot.img: `abootimg -x boot.img`" >> ../release/README.md
          echo "3. æ›¿æ¢å†…æ ¸: `cp boot/Image.gz-dtb è§£åŒ…ç›®å½•ä¸­çš„å†…æ ¸æ–‡ä»¶`" >> ../release/README.md
          echo "4. é‡æ–°æ‰“åŒ…boot.img: `abootimg --create newboot.img -f bootimg.cfg -k Image.gz-dtb -r initrd.img`" >> ../release/README.md
          echo "5. åˆ·å…¥æ–°çš„boot.img: `fastboot flash boot newboot.img`" >> ../release/README.md
          echo "6. å®‰è£…KernelSUç®¡ç†å™¨: å®‰è£…release/system/KernelSU.apk" >> ../release/README.md
          echo "" >> ../release/README.md
          echo "## é€‚ç”¨äºæ ‘è“æ´¾OS" >> ../release/README.md
          echo "1. æŒ‚è½½bootåˆ†åŒº" >> ../release/README.md
          echo "2. å¤‡ä»½åŸå§‹kernel8.img" >> ../release/README.md
          echo "3. å¤åˆ¶boot/kernel8.imgåˆ°bootåˆ†åŒº" >> ../release/README.md
          echo "4. å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥æ›´æ–°dtbså’Œoverlaysç›®å½•" >> ../release/README.md
          echo "5. é‡å¯ç³»ç»Ÿ" >> ../release/README.md
          echo "6. å®‰è£…release/system/KernelSU.apk" >> ../release/README.md
          echo "" >> ../release/README.md
          echo "## æ¢å¤æ–¹æ³•" >> ../release/README.md
          echo "å¦‚æœç³»ç»Ÿæ— æ³•å¯åŠ¨ï¼Œè¯·æ¢å¤å¤‡ä»½çš„åŸå§‹å†…æ ¸æ–‡ä»¶ã€‚" >> ../release/README.md
          
          # åˆ›å»ºå‘å¸ƒZIPåŒ…
          cd ../release
          zip -r9 ../rpi4-kernelsu-${{ steps.date.outputs.date }}.zip ./*
          cd ..
          
          echo "âœ… å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ: $(ls -lh rpi4-kernelsu-${{ steps.date.outputs.date }}.zip)"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpi4-kernelsu-${{ steps.date.outputs.date }}
          path: |
            release
            ${{ env.KERNEL_PATH }}/out/arch/${{ env.ARCH }}/boot/Image.gz-dtb
            ${{ env.KERNEL_PATH }}/build.log
            rpi4-kernelsu-${{ steps.date.outputs.date }}.zip
          retention-days: 7

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rpi4-kernelsu-${{ steps.date.outputs.date }}.zip
            ${{ env.KERNEL_PATH }}/out/arch/${{ env.ARCH }}/boot/Image.gz-dtb
          name: RPI4 KernelSU ${{ github.event.inputs.ANDROID_BRANCH }} - ${{ steps.date.outputs.date }}
          tag_name: kernelsu-${{ steps.date.outputs.date }}
          body: |
            # æ ‘è“æ´¾4 KernelSU
            
            é›†æˆäº†KernelSUçš„æ ‘è“æ´¾4å†…æ ¸ï¼Œç”¨äºAndroidæˆ–æ ‘è“æ´¾OSç³»ç»Ÿã€‚
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - Androidåˆ†æ”¯: ${{ github.event.inputs.ANDROID_BRANCH }}
            - KernelSUç‰ˆæœ¬: ${{ github.event.inputs.KERNELSU_VERSION }}
            - æ„å»ºæ—¥æœŸ: ${{ steps.date.outputs.date }}
            
            ## åŒ…å«æ–‡ä»¶
            - å®Œæ•´æ ¼å¼çš„å†…æ ¸æ–‡ä»¶(Image.gz-dtb)
            - æ‰€æœ‰å¿…è¦çš„DTBæ–‡ä»¶
            - è®¾å¤‡æ ‘è¦†ç›–æ–‡ä»¶(overlays)
            - KernelSUç®¡ç†å™¨APK
            - è¯¦ç»†çš„å®‰è£…æŒ‡å—
            
            ## ä½¿ç”¨è¯´æ˜
            è§£å‹ZIPåŒ…åï¼ŒæŒ‰ç…§README.mdä¸­çš„è¯´æ˜è¿›è¡Œå®‰è£…ã€‚
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
